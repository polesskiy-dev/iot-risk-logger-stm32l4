name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Least-privilege defaults
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-24.04

    # Simple matrix, ready to extend later (e.g. add "tests", "release", etc.)
    strategy:
      matrix:
        target: [all]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi make

      - name: Build firmware (${{ matrix.target }})
        working-directory: firmware/iot-risk-logger-stm32l4
        run: make ${{ matrix.target }}

      - name: Calculate Flash and RAM usage
        working-directory: firmware/iot-risk-logger-stm32l4
        run: |
          # Find ELF in build directory (adjust if your structure differs)
          ELF_FILE=$(find build -maxdepth 1 -name '*.elf' | head -n 1)

          if [ -z "$ELF_FILE" ]; then
            echo "No ELF file found in build/"; exit 1;
          fi

          echo "Using ELF_FILE: $ELF_FILE"
          SIZE_OUTPUT=$(arm-none-eabi-size "$ELF_FILE")
          echo "$SIZE_OUTPUT"

          TEXT_SIZE=$(echo "$SIZE_OUTPUT" | awk 'NR==2 {print $1}')
          DATA_SIZE=$(echo "$SIZE_OUTPUT" | awk 'NR==2 {print $2}')
          BSS_SIZE=$(echo "$SIZE_OUTPUT" | awk 'NR==2 {print $3}')

          FLASH_USAGE=$((TEXT_SIZE + DATA_SIZE))
          RAM_USAGE=$((DATA_SIZE + BSS_SIZE))

          FLASH_KB=$(((FLASH_USAGE + 1023) / 1024))
          RAM_KB=$(((RAM_USAGE + 1023) / 1024))

          FLASH_MAX=128  # KB (STM32L433 Flash)
          SRAM_MAX=40    # KB

          FLASH_USAGE_PERCENT=$(((FLASH_KB * 100) / FLASH_MAX))
          SRAM_USAGE_PERCENT=$(((RAM_KB * 100) / SRAM_MAX))

          cat > memory-usage-${{ matrix.target }}.json <<EOF
          {
            "target": "${{ matrix.target }}",
            "flash": "${FLASH_KB}K/${FLASH_MAX}K (${FLASH_USAGE_PERCENT}%)",
            "SRAM": "${RAM_KB}K/${SRAM_MAX}K (${SRAM_USAGE_PERCENT}%)"
          }
          EOF

          echo "Generated memory-usage-${{ matrix.target }}.json:"
          cat memory-usage-${{ matrix.target }}.json

          # Also publish as job summary
          echo "## Firmware memory usage (${{ matrix.target }})" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          cat memory-usage-${{ matrix.target }}.json >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.target }}
          path: |
            firmware/iot-risk-logger-stm32l4/build/
            firmware/iot-risk-logger-stm32l4/*.elf
            firmware/iot-risk-logger-stm32l4/*.map
            firmware/iot-risk-logger-stm32l4/memory-usage-${{ matrix.target }}.json
          if-no-files-found: error
          retention-days: 7

  generate-diagrams:
    runs-on: ubuntu-24.04
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Download firmware build artifacts
        uses: actions/download-artifact@v4
        with:
          # Collect all matrix variants into one dir
          pattern: build-artifacts-*
          merge-multiple: true
          path: build-artifacts

      - name: Install diagram tools
        run: |
          sudo apt-get update
          # Add whatever you actually need here:
          sudo apt-get install -y graphviz

      - name: Generate diagrams
        working-directory: firmware/iot-risk-logger-stm32l4
        run: |
          echo "Run your diagram generation commands here"
          # Example (once you add them to the repo):
          # doxygen Doxyfile
          # ./scripts/generate_state_machine_diagrams.sh

      - name: Upload diagrams
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: diagrams
          path: |
            firmware/iot-risk-logger-stm32l4/docs/diagrams/
          if-no-files-found: ignore
          retention-days: 7
